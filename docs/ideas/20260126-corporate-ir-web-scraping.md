# 企業Webページからの情報取得機能

> 作成日: 2026-01-26
> ステータス: draft
> 優先度: P0（P1から昇格）

## 概要

企業の公式IRページから決算説明会資料、適時開示資料、事業ニュースを自動取得し、LLMで要約・重要ポイント抽出を行う機能。

## 背景

### 現状の課題

- EDINETでは有価証券報告書等の法定開示書類は取得できるが、決算説明会資料や中期経営計画は企業サイトにしかない
- 適時開示（業績予想修正、M&A発表等）はTDnetが主だが、有料API（月額数十万円）のため企業サイトからの取得が現実的
- 企業ごとにIRページの構造が異なり、手動での情報収集に時間がかかる

### 解決したいこと

- 保有銘柄のIR情報を効率的に収集・要約
- 株価に影響のある適時開示を見逃さない
- アドホックに気になる企業のIR情報も調査可能にする

## 解決策

### アプローチ: ハイブリッド方式

1. **登録企業（3-5社）**: YAML + Pythonテンプレート方式
   - 高精度な情報取得
   - 日次バッチで定期チェック

2. **アドホック調査**: LLMによる動的解析
   - Playwrightでページ取得 → LLMで構造解析
   - 汎用性重視、精度はベストエフォート

### 代替案と比較

| アプローチ | メリット | デメリット |
|-----------|---------|-----------|
| テンプレート方式のみ | 高精度 | 新規企業追加に工数 |
| LLM解析のみ | 汎用的 | 精度にばらつき、コスト |
| **ハイブリッド（採用）** | 両方の利点 | 実装が複雑 |

## 実装する機能

### 機能1: 企業テンプレート登録

YAML + Pythonハイブリッドでのテンプレート定義:

```yaml
# config/ir_templates/toyota.yaml
company:
  sec_code: "7203"
  edinet_code: "E02144"
  name: "トヨタ自動車"

ir_page:
  base_url: "https://global.toyota/jp/ir/"

  sections:
    earnings_materials:
      url: "library/earnings/"
      selector: "a.pdf-link"

    news:
      url: "news/"
      selector: "ul.news-list li"

  disclosures:
    url: "news/"
    categories:
      - 業績予想
      - M&A
      - 配当
```

複雑なケース（JavaScript動的ロード等）はPythonクラスでオーバーライド。

### 機能2: IR資料取得

**取得対象（MVP）:**

| カテゴリ | 資料種別 |
|---------|---------|
| 決算関連 | 決算説明会資料（PDF） |
| 適時開示 | 業績予想修正、配当予想修正、M&A・資本提携、自己株式取得、新株発行・増資 |
| 事業ニュース | 新製品・サービス発表、大型受注・契約締結、訴訟・係争関連、経営陣異動 |

### 機能3: 自動要約・重要ポイント抽出

取得時に自動でLLM要約を実行:

```markdown
# トヨタ自動車 2024Q4 決算説明会資料 要約

## 全体要約
2024年度第4四半期の業績は売上高45兆円（前年比+12%）、
営業利益5.3兆円と過去最高を記録。EV投資の加速と
為替効果が業績を押し上げた。

## 株価影響ポイント
- 🔺 2025年度業績予想を上方修正（営業利益+15%）
- 🔺 EV投資計画を1.5兆円に拡大
- 🔻 為替変動リスク（1円=400億円影響）
- ⚠️ 中国市場での販売減速懸念
```

### 機能4: アドホック調査（LLM動的解析）

未登録企業のIRページを動的に解析:

1. PlaywrightでIRページをレンダリング
2. ページ構造をLLMに送信
3. LLMが資料リンクを抽出
4. PDFダウンロード → 要約

### 機能5: CLI対応

```bash
# 登録企業のIR資料を取得
cra ir-fetch --sec-code 7203

# 全登録企業の日次バッチ
cra ir-fetch --all

# アドホック調査
cra ir-fetch --url "https://www.sony.com/ja/SonyInfo/IR/"

# 特定カテゴリのみ
cra ir-fetch --sec-code 7203 --category earnings
```

### 機能6: 自然言語オーケストレーター統合

既存の`QueryOrchestrator`に新規ツールを追加:

```python
# 追加ツール
- fetch_ir_documents: 登録企業のIR資料取得
- fetch_ir_news: IRニュース一覧取得
- explore_ir_page: アドホックでIRページを解析（LLM使用）
```

利用例:
```
「トヨタの決算説明会資料を取得して」
「ソニーのIRページから最新ニュースを探して」
```

### 機能7: 日次バッチ処理

登録企業のIRページを日次でチェックし、新規資料を自動取得・要約。

## 受け入れ条件

### 企業テンプレート登録
- [ ] YAMLファイルで企業IRページの構造を定義できる
- [ ] 複雑なケースはPythonクラスでオーバーライドできる
- [ ] 3-5社の初期テンプレートが用意されている

### IR資料取得
- [ ] 決算説明会資料（PDF）を取得できる
- [ ] 適時開示資料（業績修正、M&A等）を取得できる
- [ ] 事業ニュース（新製品、大型受注等）を取得できる
- [ ] robots.txtを遵守し、適切な間隔（1秒以上）でアクセスする

### 自動要約
- [ ] PDF取得時に自動でLLM要約が実行される
- [ ] 全体要約（1-2段落）が生成される
- [ ] 株価影響ポイント（箇条書き）が抽出される

### アドホック調査
- [ ] 未登録企業のIRページURLを指定して調査できる
- [ ] LLMがページ構造を解析し、資料リンクを抽出できる

### CLI
- [ ] `cra ir-fetch`コマンドで資料取得できる
- [ ] `--url`オプションでアドホック調査できる
- [ ] `--all`オプションで全登録企業を処理できる

### オーケストレーター統合
- [ ] 「決算説明会資料を取得して」で資料取得できる
- [ ] 「IRニュースを探して」でニュース一覧を取得できる

### エラーハンドリング
- [ ] サイト構造変更時、LLM解析にフォールバックする
- [ ] フォールバックも失敗した場合、エラーログを出力して続行する

### データ保存
- [ ] 取得したPDFはローカルディレクトリに保存される
- [ ] ディレクトリ構造: `data/ir/{sec_code}/{category}/{filename}`

## スコープ外

- データベースへのメタデータ保存（将来対応）
- リアルタイム監視（数時間ごとのチェック）
- 中期経営計画の自動分析（要約のみ対応）
- 統合報告書/アニュアルレポートの取得
- 株主通信/株主優待情報の取得

## 技術的考慮事項

### 依存コンポーネント

| コンポーネント | 用途 |
|--------------|------|
| Playwright | 動的ページのレンダリング |
| BeautifulSoup | HTML解析 |
| 既存PDFParser | PDF解析・マークダウン化 |
| 既存LLMプロバイダー | 要約・ポイント抽出 |
| 既存QueryOrchestrator | 自然言語インターフェース |

### ディレクトリ構造

```
src/company_research_agent/
├── clients/
│   └── ir_scraper/
│       ├── __init__.py
│       ├── base.py          # BaseIRScraper
│       ├── template_loader.py
│       └── llm_explorer.py  # アドホック用LLM解析
├── cli/commands/
│   └── ir_fetch.py          # CLIコマンド
└── tools/
    └── ir_tools.py          # オーケストレーター用ツール

config/
└── ir_templates/
    ├── toyota.yaml
    ├── sony.yaml
    └── ...

data/
└── ir/
    └── 7203/
        ├── earnings/
        │   └── 2024Q4_決算説明会資料.pdf
        └── news/
            └── 2024-01-15_業績予想修正.pdf
```

### リスクと対策

| リスク | 影響 | 対策 |
|-------|------|------|
| サイト構造変更 | 高 | LLMフォールバック + アラート通知 |
| JavaScript動的ロード | 中 | Playwrightで対応 |
| robots.txt制限 | 中 | 遵守、必要に応じて手動対応 |
| LLM解析の精度 | 中 | プロンプト改善、人間確認フロー |

## 更新履歴

- 2026-01-26: 初版作成（ブレインストーミングセッション）
