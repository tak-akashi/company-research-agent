# 要求内容

## 概要

「トヨタ自動車の直近の有価証券報告書」のような自然言語クエリから、適切なEDINET書類を検索・分析できる機能を、**企業リサーチの様々な質問に対応できるオーケストレーター**として実装する。

## 背景

現在のEDINET検索機能は、EDINETコードや証券コードを直接指定する必要があり、ユーザーフレンドリーではない。自然言語でのクエリ入力から適切な企業・書類を特定し、必要に応じて分析まで行う統合的なインターフェースが求められている。

課題:
- EDINET APIには企業名検索パラメータがない（日付単位の書類一覧のみ）
- 企業名からEDINETコード/証券コードへの変換が必要
- 「有報」「四半期」などの略称の解釈が必要
- 「直近」「2024年度」などの期間表現の解釈が必要
- ユーザーの意図（検索/分析/比較/要約）に応じた処理の切り替えが必要

## 設計方針

**ReActエージェント + ツール群**:
- LLMがユーザーの意図を解釈し、適切なツールを選択・実行
- ユーザーの指示に基づいて処理の深さを制御（「探して」vs「分析して」）
- 既存資産（AnalysisGraph, PDFParser）を最大限活用
- 将来の拡張（新ツール追加）が容易な構造

## 利用シナリオ

| クエリ例 | 意図 | 処理 |
|---------|------|------|
| 「トヨタの有報を探して」 | 検索 | 企業検索 → 書類検索 |
| 「トヨタの有報をダウンロード」 | 取得 | 企業検索 → 書類検索 → ダウンロード |
| 「トヨタの事業を分析して」 | 分析 | 企業検索 → 書類検索 → DL → AnalysisGraph |
| 「トヨタとホンダを比較して」 | 比較 | 複数企業検索 → 複数書類 → 比較分析 |
| 「この有報を要約して」 | 要約 | PDF解析 → LLM要約 |

## 実装対象の機能

### 1. ツール群

#### 検索系ツール
- **search_company**: 企業名で検索し、類似度スコア付き候補リストを返す
- **search_documents**: EDINET書類を検索する
- **download_document**: 書類をダウンロードし、ローカルパスを返す

#### 分析系ツール
- **analyze_document**: 書類を分析し、統合レポートを生成する（AnalysisGraph wrapper）
- **compare_documents**: 複数の書類を比較分析する（PDFParser + LLM）
- **summarize_document**: 書類を要約する（PDFParser + LLM）

### 2. オーケストレーター
- **QueryOrchestrator**: ReActエージェントとしてツールを動的に選択・実行

### 3. 基盤クライアント
- **EDINETCodeListClient**: コードリストのダウンロード・キャッシュ・検索

## 受け入れ条件

### 企業検索
- [ ] 「トヨタ」で検索すると「トヨタ自動車」「トヨタ紡織」等が候補として返る
- [ ] 各候補に類似度スコア（0-100）が付与される
- [ ] EDINETコードで直接検索できる
- [ ] 証券コードで直接検索できる

### クエリ処理
- [ ] 「トヨタの有報を探して」→ 書類リストを返す
- [ ] 「トヨタの有報を分析して」→ AnalysisGraphで分析、統合レポートを返す
- [ ] 「トヨタとホンダを比較して」→ 比較レポートを返す
- [ ] 「この有報を要約して」→ 要約を返す

### キャッシュ
- [ ] 初回起動時にEDINETコードリストをダウンロードする
- [ ] 2回目以降はキャッシュを使用する
- [ ] キャッシュ有効期限（7日）が切れたら再ダウンロードする
- [ ] 強制更新オプションがある

## 成功指標

- 企業名検索のレスポンス時間が100ms以下（キャッシュ済みの場合）
- 類似度スコアのトップ候補の正解率が90%以上
- ユニットテストカバレッジ80%以上
- オーケストレーターが適切なツールを選択する成功率90%以上

## 既存資産の活用

| 既存資産 | 活用先 |
|---------|--------|
| `EDINETClient` | search_documents, download_document |
| `EDINETDocumentService` | search_documents |
| `AnalysisGraph` | analyze_document |
| `PDFParser` | compare_documents, summarize_document |
| `LLMProvider` | オーケストレーター、compare、summarize |

## スコープ外

以下はこのフェーズでは実装しない:

- REST APIエンドポイント（api/層）の追加
- データベース永続化（PostgreSQL）
- Streamlit UI

## 参照ドキュメント

- `docs/product-requirements.md` - プロダクト要求定義書
- `docs/functional-design.md` - 機能設計書
- `docs/research/edinet-api-specification.md` - EDINET API仕様
- `.steering/20260117-EDINET-search-filter/` - EDINET検索フィルタ機能
- `.steering/20260117-LLM分析機能-LangGraph/` - LLM分析機能
